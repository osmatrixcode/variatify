console.log("hello from load-main.js");const i=document.createElement("script");i.src=chrome.runtime.getURL("src/injected/main.js"),i.onload=function(){this.remove()},(document.head||document.documentElement).appendChild(i);async function r(t,e){try{const o=(await chrome.storage.local.get("tunevo_song_settings")).tunevo_song_settings||{};return o[t]=e,await chrome.storage.local.set({tunevo_song_settings:o}),console.log(`\u{1F4BE} Saved setting for "${t}":`,e),!0}catch(n){return console.error("Error saving song setting:",n),!1}}async function c(t){try{const o=((await chrome.storage.local.get("tunevo_song_settings")).tunevo_song_settings||{})[t];if(o)return console.log(`\u{1F4C2} Loaded setting for "${t}":`,o),o}catch(e){console.error("Error loading song setting:",e)}return null}async function l(t){try{const n=(await chrome.storage.local.get("tunevo_song_settings")).tunevo_song_settings||{};return delete n[t],await chrome.storage.local.set({tunevo_song_settings:n}),console.log(`\u{1F5D1}\uFE0F Cleared setting for "${t}"`),!0}catch(e){return console.error("Error clearing song setting:",e),!1}}async function g(){try{const e=(await chrome.storage.local.get("tunevo_song_settings")).tunevo_song_settings||{};return console.log("\u{1F4CB} All saved song settings:",e),e}catch(t){return console.error("Error listing saved settings:",t),{}}}chrome.runtime.onMessage.addListener(function(t,e,n){if(t.source==="popup")if(t.action==="getCurrentSong"){const o=d();n({songInfo:o})}else if(t.action==="getCurrentSetting"||t.action==="clearCurrentSetting"||t.action==="listAllSettings"){if(!a()){n({error:"Authentication required"});return}return window.postMessage({action:t.action,source:"content-script"},"*"),!0}else if(t.action==="enableStreamingMode"||t.action==="disableStreamingMode"||t.action==="updateStreamingRate"){if(!a()){n({error:"Authentication required"});return}window.postMessage({action:t.action,data:t.data,source:"content-script"},"*"),n({status:"Streaming mode message forwarded to injected script"})}else{if(!a()){n({error:"Authentication required"});return}window.postMessage({action:t.action,source:"content-script"},"*"),n({status:"Message forwarded to injected script"})}});function d(){try{const t=['[data-testid="now-playing-widget"] [data-testid="context-item-info-title"]','[data-testid="context-item-info-title"]','.now-playing-bar [data-testid="context-item-info-title"]',".now-playing-bar .track-info__name",'[data-testid="track-info"] [data-testid="context-item-info-title"]',".track-info__name"];let e="Not playing";for(let n of t){const o=document.querySelector(n);if(o&&o.textContent.trim()){e=o.textContent.trim();break}}if(e==="Not playing"){const n=document.title;if(n&&n.includes(" - ")){const o=n.split(" - ");o.length>=2&&(e=o[0].trim())}}return{title:e}}catch(t){return console.error("Error getting song info:",t),{title:"Not playing"}}}window.addEventListener("message",function(t){t.data.source==="injected-script"&&(console.log("Response from injected script:",t.data),t.data.action==="saveSongSetting"?r(t.data.songId,t.data.effect).then(e=>{window.postMessage({source:"content-script",action:"saveSongSettingResponse",success:e},"*")}):t.data.action==="loadSongSetting"?c(t.data.songId).then(e=>{window.postMessage({source:"content-script",action:"loadSongSettingResponse",songId:t.data.songId,setting:e},"*")}):t.data.action==="clearSongSetting"?l(t.data.songId).then(e=>{window.postMessage({source:"content-script",action:"clearSongSettingResponse",songId:t.data.songId,success:e},"*")}):t.data.action==="listAllSettings"&&g().then(e=>{window.postMessage({source:"content-script",action:"listAllSettingsResponse",settings:e},"*")}),(t.data.action==="currentSetting"||t.data.action==="settingCleared"||t.data.action==="allSettings")&&(console.log("\u{1F527} Forwarding message to popup:",t.data.action,t.data),chrome.runtime.sendMessage({source:"content-script",action:t.data.action,data:t.data})))});const s=ExtPay("tunevo-test");function a(){return console.log("\u{1F510} Content script authentication:",window.contentScriptAuthenticated),window.contentScriptAuthenticated||!1}s.getUser().then(t=>{const e=t.trialStartedAt&&(()=>{const n=new Date,o=new Date(t.trialStartedAt.getTime()+10080*60*1e3);return n<o})();if(window.contentScriptAuthenticated=t.paid||e,!t.paid&&t.trialStartedAt){const n=new Date,o=new Date(t.trialStartedAt.getTime()+10080*60*1e3);n>=o&&p()}}).catch(t=>{console.error("ExtPay error in content script:",t),window.contentScriptAuthenticated=!0,console.log("\u{1F510} Content script: ExtPay failed, allowing access as fallback")});function p(){const t=document.createElement("div");t.style.cssText=`
    position: fixed;
    top: 20px;
    right: 20px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 12px 16px;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    z-index: 10000;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    font-size: 14px;
    max-width: 250px;
    cursor: pointer;
    transition: all 0.3s ease;
  `,t.innerHTML=`
    <div style="display: flex; align-items: center; gap: 8px;">
      <span>\u{1F3A7}</span>
      <div>
        <div style="font-weight: 600; margin-bottom: 4px;">Tunevo Premium</div>
        <div style="font-size: 12px; opacity: 0.9;">Trial expired - Upgrade now!</div>
      </div>
    </div>
  `,t.addEventListener("click",()=>{s.openPaymentPage()}),t.addEventListener("mouseenter",()=>{t.style.transform="translateY(-2px)",t.style.boxShadow="0 6px 16px rgba(0,0,0,0.4)"}),t.addEventListener("mouseleave",()=>{t.style.transform="translateY(0)",t.style.boxShadow="0 4px 12px rgba(0,0,0,0.3)"}),document.body.appendChild(t),setTimeout(()=>{t.parentNode&&(t.style.opacity="0",t.style.transform="translateY(-10px)",setTimeout(()=>{t.parentNode&&t.parentNode.removeChild(t)},300))},1e4)}
