const v=document.createElement,f=[];let s={rate:1,pitch:!0,name:"normal speed"},o=null,i={enabled:!1,rate:"normal"};function w(e){return e.toLowerCase().trim()}function g(e,t){window.postMessage({source:"injected-script",action:"saveSongSetting",songId:e,effect:t},"*");const n=function(a){a.data.source==="content-script"&&a.data.action==="saveSongSettingResponse"&&(window.removeEventListener("message",n),a.data.success?console.log(`\u2705 Successfully saved setting for "${e}"`):console.error(`\u274C Failed to save setting for "${e}"`))};window.addEventListener("message",n),setTimeout(()=>{window.removeEventListener("message",n)},2e3)}function l(e){return new Promise(t=>{const n=function(a){a.data.source==="content-script"&&a.data.action==="loadSongSettingResponse"&&a.data.songId===e&&(window.removeEventListener("message",n),t(a.data.setting))};window.addEventListener("message",n),window.postMessage({source:"injected-script",action:"loadSongSetting",songId:e},"*"),setTimeout(()=>{window.removeEventListener("message",n),console.warn(`\u26A0\uFE0F Timeout loading setting for "${e}", falling back to null`),t(null)},1e3)})}function b(){try{const e=['[data-testid="now-playing-widget"] [data-testid="context-item-info-title"]','[data-testid="context-item-info-title"]','.now-playing-bar [data-testid="context-item-info-title"]',".now-playing-bar .track-info__name",'[data-testid="track-info"] [data-testid="context-item-info-title"]',".track-info__name"];let t="Not playing";for(let n of e){const a=document.querySelector(n);if(a&&a.textContent.trim()){t=a.textContent.trim();break}}if(t==="Not playing"){const n=document.title;if(n&&n.includes(" - ")){const a=n.split(" - ");a.length>=2&&(t=a[0].trim())}}return{title:t}}catch(e){return console.error("Error getting song info:",e),{title:"Not playing"}}}function S(){const e=b(),t=w(e.title);t!==o&&e.title!=="Not playing"&&(console.log(`\u{1F3B5} Song changed from "${o}" to "${t}"`),o=t,i.enabled?(console.log(`\u{1F3B5} Streaming mode active, applying ${i.rate} to new song "${t}"`),u(i.rate)):l(t).then(n=>{n?(console.log(`\u{1F504} Applying saved setting for "${t}":`,n),p(n.name)):(console.log(`\u{1F4DD} No saved setting found for "${t}", resetting to normal speed`),d())})),e.title!=="Not playing"&&Math.random()<.1&&console.log(`\u{1F3B5} Currently playing: "${e.title}" (ID: ${t})`)}function p(e){switch(e){case"speedUp":h();break;case"normalSpeed":k();break;case"slowed":y();break;default:console.log("Unknown effect name:",e)}}function M(){return o?l(o):Promise.resolve(null)}function E(e){window.postMessage({source:"injected-script",action:"clearSongSetting",songId:e},"*")}function $(){return new Promise(e=>{const t=function(n){n.data.source==="content-script"&&n.data.action==="listAllSettingsResponse"&&(window.removeEventListener("message",t),e(n.data.settings))};window.addEventListener("message",t),window.postMessage({source:"injected-script",action:"listAllSettings"},"*"),setTimeout(()=>{window.removeEventListener("message",t),e({})},1e3)})}document.createElement=function(e,...t){const n=v.call(this,e,...t);return(e==="audio"||e==="video")&&f.push(n),n};const c=Object.getOwnPropertyDescriptor(HTMLMediaElement.prototype,"playbackRate");Object.defineProperty(HTMLMediaElement.prototype,"playbackRate",{set(e){if(this.parentElement?.className.toLowerCase().includes("canvas")){c.set.call(this,1);return}e.source!=="tunevo"?(console.info("\u{1F3A7} Tunevo: Prevented unintended playback rate change."),c.set.call(this,s.rate)):c.set.call(this,e.value)},get(){return c.get.call(this)}});function r(e=null,t=null){if(i.enabled&&e===null)switch(console.log(`\u{1F3B5} Streaming mode active, using streaming rate: ${i.rate}`),i.rate){case"slowed":e=.8,t=!1;break;case"normal":e=1,t=!0;break;case"speedUp":e=1.25,t=!1;break}const n=e!==null?e:s.rate,a=t!==null?t:s.pitch;f.forEach(m=>{m.playbackRate={source:"tunevo",value:n},m.preservesPitch=a,console.log(`\u{1F39B}\uFE0F Applied: ${n}x speed, preservesPitch = ${a}`)})}function h(){s={rate:1.25,pitch:!1,name:"speedUp"},r(1.25,!1),o&&g(o,s),console.log("\u{1F680} Speed up effect applied")}function k(){s={rate:1,pitch:!0,name:"normalSpeed"},r(1,!0),o&&g(o,s),console.log("\u{1F3B5} Normal speed restored")}function y(){s={rate:.8,pitch:!1,name:"slowed"},r(.8,!1),o&&g(o,s),console.log("\u{1F40C} Slowed effect applied")}function d(){s={rate:1,pitch:!0,name:"normalSpeed"},r(1,!0),console.log("\u{1F3B5} Reset to normal speed (no saved setting)")}function R(e){switch(console.log("\u{1F527} enableStreamingMode called with rate:",e),i.enabled=!0,i.rate=e,e){case"slowed":s={rate:.8,pitch:!1,name:"streaming_slowed"};break;case"normal":s={rate:1,pitch:!0,name:"streaming_normal"};break;case"speedUp":s={rate:1.25,pitch:!1,name:"streaming_speedUp"};break}u(e),console.log(`\u{1F3B5} Streaming mode enabled with ${e} playback, currentEffect updated:`,s)}function C(){console.log("\u{1F527} disableStreamingMode called"),i.enabled=!1,o?l(o).then(e=>{e?(console.log(`\u{1F504} Restoring saved setting for "${o}":`,e),p(e.name)):(console.log(`\u{1F4DD} No saved setting found for "${o}", resetting to normal speed`),d())}):(console.log("\u{1F4DD} No current song ID, resetting to normal speed"),d()),console.log("\u{1F3B5} Streaming mode disabled, restored per-song settings")}function L(e){if(i.enabled){switch(console.log("\u{1F527} updateStreamingRate called with rate:",e),i.rate=e,e){case"slowed":s={rate:.8,pitch:!1,name:"streaming_slowed"};break;case"normal":s={rate:1,pitch:!0,name:"streaming_normal"};break;case"speedUp":s={rate:1.25,pitch:!1,name:"streaming_speedUp"};break}u(e),console.log(`\u{1F3B5} Streaming rate updated to ${e}, currentEffect updated:`,s)}}function u(e){switch(console.log("\u{1F527} applyStreamingRate called with rate:",e),e){case"slowed":console.log("\u{1F527} Applying slowed rate: 0.8x"),r(.8,!1);break;case"normal":console.log("\u{1F527} Applying normal rate: 1.0x"),r(1,!0);break;case"speedUp":console.log("\u{1F527} Applying speed up rate: 1.25x"),r(1.25,!1);break;default:console.log("Unknown streaming rate:",e),r(1,!0)}}const T=()=>{new MutationObserver(()=>{r(),S()}).observe(document.body,{childList:!0,subtree:!0}),setInterval(()=>{r(),S()},1e3)};console.log("\u{1F680} Tunevo initializing..."),setTimeout(()=>{T(),r();const e=b();o=w(e.title),o&&e.title!=="Not playing"&&l(o).then(t=>{t&&(console.log(`\u{1F504} Applying saved setting for current song "${o}":`,t),p(t.name))}),console.log("\u2705 Tunevo running.")},2e3),window.addEventListener("message",function(e){if(e.data.source==="content-script"){switch(console.log("Received message from popup:",e.data.action,e.data),e.data.action){case"speedUp":i.enabled||h();break;case"normalSpeed":i.enabled||k();break;case"slowed":i.enabled||y();break;case"enableStreamingMode":console.log("\u{1F527} Processing enableStreamingMode message:",e.data),R(e.data.data.rate);break;case"disableStreamingMode":C();break;case"updateStreamingRate":L(e.data.data.rate);break;case"getCurrentSetting":if(console.log("\u{1F527} getCurrentSetting called, streamingMode.enabled:",i.enabled),i.enabled){const t={name:"streaming",rate:i.rate};console.log("\u{1F527} Sending streaming mode setting:",t),window.postMessage({source:"injected-script",action:"currentSetting",setting:t},"*")}else M().then(t=>{console.log("\u{1F527} Sending per-song setting:",t),window.postMessage({source:"injected-script",action:"currentSetting",setting:t},"*")});break;case"clearCurrentSetting":!i.enabled&&o&&E(o),d(),window.postMessage({source:"injected-script",action:"settingCleared",songId:o},"*");break;case"listAllSettings":$().then(t=>{window.postMessage({source:"injected-script",action:"allSettings",settings:t},"*")});break;default:console.log("Unknown action:",e.data.action)}["getCurrentSetting","clearCurrentSetting","enableStreamingMode","disableStreamingMode","updateStreamingRate"].includes(e.data.action)||window.postMessage({source:"injected-script",status:"Action executed: "+e.data.action},"*")}});
