const u=ExtPay("tunevo-test"),k=10080*60*1e3;function A(t){if(!t.trialStartedAt)return!1;const e=new Date,n=new Date(t.trialStartedAt.getTime()+k);return e<n}function N(t){if(!t.trialStartedAt)return 0;const e=new Date,o=new Date(t.trialStartedAt.getTime()+k)-e;return Math.max(0,Math.ceil(o/(1440*60*1e3)))}function h(t){const e=document.getElementById("paymentText"),n=document.getElementById("trialBtn"),o=document.getElementById("payBtn"),s=document.getElementById("manageBtn");if(t.paid)e.innerHTML="\u{1F389} Premium Lifetime Access!",n.style.display="none",o.style.display="none",s.style.display="inline-block",b();else if(A(t)){const a=N(t);e.innerHTML=`\u23F0 Free Trial: ${a} days left`,n.style.display="none",o.style.display="inline-block",s.style.display="none",b()}else t.trialStartedAt?(e.innerHTML="\u{1F4B3} Trial Expired - Upgrade Now!",n.style.display="none",o.style.display="inline-block",s.style.display="none",L()):(e.innerHTML="\u{1F512} Sign up required to use Tunevo",n.style.display="inline-block",o.style.display="none",s.style.display="none",L())}function b(){const t=document.querySelector(".controls"),e=document.querySelector(".streaming-mode"),n=document.querySelector(".clear-all-section"),o=document.querySelector(".import-export-section");t&&(t.style.opacity="1"),e&&(e.style.opacity="1"),n&&(n.style.opacity="1"),o&&(o.style.opacity="1"),document.querySelectorAll(".control-btn, .clear-btn, .clear-all-btn, .import-export-btn").forEach(l=>{l.disabled=!1,l.style.cursor="pointer"});const a=document.getElementById("streamingToggle");a&&(a.disabled=!1,a.style.cursor="pointer")}function L(){const t=document.querySelector(".controls"),e=document.querySelector(".streaming-mode"),n=document.querySelector(".clear-all-section"),o=document.querySelector(".import-export-section");t&&(t.style.opacity="0.5"),e&&(e.style.opacity="0.5"),n&&(n.style.opacity="0.5"),o&&(o.style.opacity="0.5"),document.querySelectorAll(".control-btn, .clear-btn, .clear-all-btn, .import-export-btn").forEach(l=>{l.disabled=!0,l.style.cursor="not-allowed"});const a=document.getElementById("streamingToggle");a&&(a.disabled=!0,a.style.cursor="not-allowed")}function g(){return console.log("\u{1F510} Checking authentication:",window.userAuthenticated),window.userAuthenticated||!1}function p(){i("\u{1F512} Please sign up for free trial to use Tunevo!")}document.addEventListener("DOMContentLoaded",function(){const t=document.getElementById("speedUpId"),e=document.getElementById("normalSpeedId"),n=document.getElementById("slowedId"),o=document.getElementById("clearSettingBtn"),s=document.getElementById("streamingToggle"),a=document.getElementById("rateSelector"),l=document.getElementById("streamingRate");let f=!1;console.log("\u{1F527} Found streaming elements:",{streamingToggle:!!s,rateSelector:!!a,streamingRate:!!l});const W=document.getElementById("songTitle"),V=document.getElementById("songArtist"),Y=document.getElementById("settingText");j(),setTimeout(()=>{console.log("\u{1F527} Checking if injected script is ready..."),c("getCurrentSetting"),setTimeout(()=>{f||(console.log("\u{1F527} Injected script not ready after timeout, proceeding anyway..."),f=!0),T(),setTimeout(()=>{f&&(console.log("\u{1F527} Periodic check: verifying streaming rate is correct..."),c("getCurrentSetting"))},2e3)},1e3)},300),t.addEventListener("click",function(){g()&&(s.checked?i("Streaming mode is active! Disable it first to use per-song settings."):(c("speedUp"),i("Speed Up applied!"),setTimeout(m,500)))}),e.addEventListener("click",function(){g()&&(s.checked?i("Streaming mode is active! Disable it first to use per-song settings."):(c("normalSpeed"),i("Normal Speed applied!"),setTimeout(m,500)))}),n.addEventListener("click",function(){g()&&(s.checked?i("Streaming mode is active! Disable it first to use per-song settings."):(c("slowed"),i("Slowed applied!"),setTimeout(m,500)))}),s.addEventListener("change",function(){if(!g()){this.checked=!1,p();return}console.log("\u{1F527} Streaming toggle changed:",this.checked);const r=this.checked;if(a.style.display=r?"flex":"none",E(r),r){const d=l.value;console.log("\u{1F527} Enabling streaming mode with rate:",d),c("enableStreamingMode",{rate:d}),i(`Streaming mode enabled with ${d} playback!`),setTimeout(m,500)}else console.log("\u{1F527} Disabling streaming mode"),c("disableStreamingMode"),i("Streaming mode disabled! Restored per-song settings."),setTimeout(m,500);R()}),l.addEventListener("change",function(){if(s.checked){const r=l.value;c("updateStreamingRate",{rate:r}),i(`Streaming rate updated to ${r}!`),setTimeout(m,500)}}),o.addEventListener("click",function(){if(!g()){p();return}s.checked?i("Streaming mode is active! Disable it first to clear per-song settings."):(c("clearCurrentSetting"),i("Setting cleared!"))}),document.getElementById("clearAllBtn").addEventListener("click",function(){if(!g()){p();return}confirm("Are you sure you want to clear ALL preferences? This will remove all saved settings and cannot be undone.")&&$()});const M=document.getElementById("exportBtn"),U=document.getElementById("importBtn"),B=document.getElementById("importFileInput");M.addEventListener("click",function(){if(!g()){p();return}q()}),U.addEventListener("click",function(){if(!g()){p();return}B.click()}),B.addEventListener("change",function(r){const d=r.target.files[0];d&&H(d)});const D=document.getElementById("trialBtn"),P=document.getElementById("payBtn"),_=document.getElementById("manageBtn");D.addEventListener("click",function(r){r.preventDefault(),u.openTrialPage("7-day")}),P.addEventListener("click",function(r){r.preventDefault(),u.openPaymentPage()}),_.addEventListener("click",function(r){r.preventDefault(),u.openPaymentPage()}),u.getUser().then(r=>{console.log("\u{1F510} ExtPay user data:",r);const d=r.paid||A(r);window.userAuthenticated=d,console.log("\u{1F510} User authenticated:",d),h(r)}).catch(r=>{console.error("ExtPay error:",r),window.userAuthenticated=!0,console.log("\u{1F510} ExtPay failed, allowing access as fallback"),document.getElementById("paymentText").innerHTML="\u{1F680} Tunevo Ready!",b()}),u.onTrialStarted.addListener(r=>{console.log("Trial started!",r),window.userAuthenticated=!0,h(r)}),u.onPaid.addListener(r=>{console.log("User paid!",r),window.userAuthenticated=!0,h(r)}),chrome.runtime.onMessage.addListener(function(r,d,J){if(r.source==="content-script")if(r.action==="currentSetting"){if(console.log("\u{1F527} Received currentSetting message:",r.data.setting),f=!0,v(r.data.setting),r.data.setting&&r.data.setting.name==="streaming"){console.log("\u{1F527} Updating streaming UI for streaming mode setting");const I=document.getElementById("streamingToggle"),w=document.getElementById("rateSelector"),y=document.getElementById("streamingRate");I.checked=!0,y.value=r.data.setting.rate,w.style.display="flex",console.log("\u{1F527} Updated streaming UI:",{toggleChecked:I.checked,rateValue:y.value,rateSelectorDisplay:w.style.display}),R(),console.log("\u{1F527} Verifying streaming rate after update:",{expectedRate:r.data.setting.rate,actualRate:y.value,options:Array.from(y.options).map(x=>({value:x.value,selected:x.selected}))})}}else r.action==="settingCleared"?v(null):r.action==="streamingModeState"&&O(r.data)})});function j(){chrome.tabs.query({active:!0,currentWindow:!0},function(t){const e=t[0];chrome.tabs.sendMessage(e.id,{action:"getCurrentSong",source:"popup"},function(n){chrome.runtime.lastError?(console.error("Error getting song info:",chrome.runtime.lastError),S("Not playing")):n&&n.songInfo?S(n.songInfo.title):S("Not playing")}),setTimeout(m,100)})}function S(t){const e=document.getElementById("songTitle"),n=document.getElementById("songArtist");e.textContent=t||"Not playing",n.textContent=""}function c(t,e=null){console.log("\u{1F527} sendMessageToContentScript called with:",t,e),chrome.tabs.query({active:!0,currentWindow:!0},function(n){const o=n[0],s={action:t,source:"popup"};e&&(s.data=e),console.log("\u{1F527} Sending message to tab:",o.id,s),chrome.tabs.sendMessage(o.id,s,function(a){chrome.runtime.lastError?console.error("Error sending message:",chrome.runtime.lastError):console.log("Message sent successfully:",a)})})}function m(){chrome.tabs.query({active:!0,currentWindow:!0},function(t){const e=t[0];chrome.tabs.sendMessage(e.id,{action:"getCurrentSetting",source:"popup"},function(n){chrome.runtime.lastError&&console.error("Error getting current setting:",chrome.runtime.lastError)})})}function v(t){const e=document.getElementById("settingText"),n=document.getElementById("clearSettingBtn");if(t)if(t.name==="streaming"){const o={speedUp:"Speed Up",normalSpeed:"Normal Speed",slowed:"Slowed"};e.textContent=`Streaming playback rate: ${o[t.rate]||t.rate}`,n.style.display="none"}else{const o={speedUp:"Speed Up",normalSpeed:"Normal Speed",slowed:"Slowed"};e.textContent=`Saved: ${o[t.name]||t.name}`,n.style.display="inline-block"}else e.textContent="No saved setting",n.style.display="none"}function i(t){const e=document.createElement("div");e.className="notification",e.textContent=t,e.style.cssText=`
        position: fixed;
        top: 10px;
        right: 10px;
        background: #50b83c;
        color: white;
        padding: 8px 12px;
        border-radius: 4px;
        font-size: 12px;
        z-index: 1000;
        opacity: 0;
        transform: translateY(-10px);
        transition: all 0.3s ease;
    `,document.body.appendChild(e),setTimeout(()=>{e.style.opacity="1",e.style.transform="translateY(0)"},10),setTimeout(()=>{e.style.opacity="0",e.style.transform="translateY(-10px)",setTimeout(()=>{document.body.removeChild(e)},300)},2e3)}function R(){const t=document.getElementById("streamingToggle"),e=document.getElementById("streamingRate"),n={enabled:t.checked,rate:e.value};chrome.storage.local.set({tunevo_streaming_mode:n},function(){console.log("Streaming mode state saved:",n)})}function T(){console.log("\u{1F527} loadStreamingModeState called"),chrome.storage.local.get("tunevo_streaming_mode",function(t){const e=t.tunevo_streaming_mode||{enabled:!1,rate:"normal"};console.log("\u{1F527} Loaded streaming mode state from storage:",e);const n=document.getElementById("streamingToggle"),o=document.getElementById("rateSelector"),s=document.getElementById("streamingRate");if(n.checked=e.enabled,s.value=e.rate,s.value!==e.rate){console.log("\u{1F527} Warning: streamingRate.value was not set correctly, forcing it...");for(let a of s.options)if(a.value===e.rate){a.selected=!0;break}}if(o.style.display=e.enabled?"flex":"none",E(e.enabled),console.log("\u{1F527} Updated UI elements:",{toggleChecked:n.checked,rateValue:s.value,rateSelectorDisplay:o.style.display}),e.enabled){if(console.log("\u{1F527} Streaming mode was enabled, restoring..."),!injectedScriptReady){console.log("\u{1F527} Injected script not ready yet, waiting..."),setTimeout(()=>T(),100);return}console.log("\u{1F527} Sending getCurrentSetting message..."),c("getCurrentSetting"),setTimeout(()=>{console.log("\u{1F527} Sending enableStreamingMode message..."),c("enableStreamingMode",{rate:e.rate})},100)}else console.log("\u{1F527} Streaming mode was not enabled")})}function O(t){const e=document.getElementById("streamingToggle"),n=document.getElementById("rateSelector"),o=document.getElementById("streamingRate");e.checked=t.enabled,o.value=t.rate,n.style.display=t.enabled?"flex":"none",E(t.enabled)}function E(t){const e=document.getElementById("speedUpId"),n=document.getElementById("normalSpeedId"),o=document.getElementById("slowedId");e.disabled=t,n.disabled=t,o.disabled=t}function $(){chrome.storage.local.clear(function(){chrome.runtime.lastError?(console.error("Error clearing storage:",chrome.runtime.lastError),i("Error clearing preferences!")):(console.log("All preferences cleared successfully"),i("All preferences cleared!"),F(),C(),window.close())})}function F(){const t=document.getElementById("streamingToggle"),e=document.getElementById("rateSelector"),n=document.getElementById("streamingRate");t.checked=!1,e.style.display="none",n.value="normal",E(!1),v(null),S("Loading...")}function C(){chrome.tabs.query({active:!0,currentWindow:!0},function(t){t[0]&&chrome.tabs.reload(t[0].id,function(){chrome.runtime.lastError?console.error("Error refreshing tab:",chrome.runtime.lastError):console.log("Tab refreshed successfully")})})}function q(){console.log("\u{1F4E4} Exporting preferences..."),chrome.storage.local.get(["tunevo_song_settings","tunevo_streaming_mode"],function(t){const e={version:"1.0",exportDate:new Date().toISOString(),songSettings:t.tunevo_song_settings||{},streamingMode:t.tunevo_streaming_mode||{enabled:!1,rate:"normal"}},n=JSON.stringify(e,null,2),o=new Blob([n],{type:"application/json"}),s=URL.createObjectURL(o),a=document.createElement("a");a.href=s,a.download=`tunevo-preferences-${new Date().toISOString().split("T")[0]}.json`,document.body.appendChild(a),a.click(),document.body.removeChild(a),URL.revokeObjectURL(s);const l=Object.keys(e.songSettings).length;i(`\u2705 Exported ${l} song preferences!`),console.log("\u{1F4E4} Export completed:",e)})}function H(t){console.log("\u{1F4E5} Importing preferences from file:",t.name);const e=new FileReader;e.onload=function(n){try{const o=JSON.parse(n.target.result);if(!o.version||!o.songSettings||!o.streamingMode)throw new Error("Invalid file format. Please select a valid Tunevo preferences file.");const s=Object.keys(o.songSettings).length,a=`Import ${s} song preferences and streaming mode settings?

This will replace your current preferences.`;if(confirm(a)){const l={tunevo_song_settings:o.songSettings,tunevo_streaming_mode:o.streamingMode};chrome.storage.local.set(l,function(){chrome.runtime.lastError?(console.error("Error importing preferences:",chrome.runtime.lastError),i("\u274C Error importing preferences!")):(console.log("\u{1F4E5} Import completed successfully:",l),i(`\u2705 Imported ${s} song preferences!`),T(),m(),C())})}}catch(o){console.error("Error parsing import file:",o),i("\u274C Invalid file format. Please select a valid Tunevo preferences file.")}},e.onerror=function(){console.error("Error reading file"),i("\u274C Error reading file. Please try again.")},e.readAsText(t)}
